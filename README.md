# 抽奖系统逻辑文档

## 概述
本系统是一个基于抽奖码的抽奖平台，用户通过输入“请输入抽奖码”进行抽奖，后台支持管理员管理奖品、生成抽奖码、查看抽奖记录。系统确保奖品库存有限、抽奖码唯一且一次性使用，并记录所有抽奖行为。

### 核心功能
- **奖品管理**：管理员可添加、编辑、删除奖品，设置库存和类型（实体/虚拟）。
- **抽奖码**：预生成唯一抽奖码，关联奖品（或无奖），验证后单次使用。
- **抽奖流程**：用户输入抽奖码，若有效且未使用，系统根据关联奖品和库存决定是否中奖。
- **记录**：记录每次抽奖，便于审计和统计。
- **后台控制**：管理员可批量生成抽奖码、监控使用情况、调整库存。

## 数据库结构

### 1. `ld_prizes` 表（奖品表）
- **用途**：存储奖品信息。
- **字段**：
    - `id`：自增主键。
    - `name`：奖品名称（如“USDT 10”）。
    - `img`：奖品图片URL。
    - `price`：奖品价格（默认0.00）。
    - `stock`：奖品库存（中奖时递减）。
    - `sort`：显示排序。
    - `email`：联系邮箱（可选）。
    - `type`：奖品类型（ENTITY=实体，VIRTUAL=虚拟）。
    - `is_delete`：软删除标志（0=未删除，1=已删除）。
    - `create_time`, `update_time`, `delete_time`：时间戳。
- **后台控制**：管理员通过后台界面增删改查奖品，设置库存。

### 2. `lottery_codes` 表（抽奖码表）
- **用途**：存储唯一的抽奖码，预关联奖品。
- **字段**：
    - `id`：自增主键。
    - `code`：抽奖码（如“LC-USDT10-001”）。
    - `prize_id`：关联奖品ID（NULL表示无奖）。
    - `is_used`：是否已使用（0=未使用，1=已使用）。
    - `used_time`：使用时间。
    - `create_time`, `update_time`：时间戳。
- **约束**：`code`唯一；`prize_id`外键关联`ld_prizes`，删除奖品时置NULL。
- **预生成**：后台脚本按奖品库存生成抽奖码，格式为“LC-[奖品名]-[序号]”。

### 3. `ld_draw_records` 表（抽奖记录表）
- **用途**：记录每次抽奖行为。
- **字段**：
    - `id`：自增主键。
    - `code_id`：关联抽奖码ID。
    - `prize_id`：中奖的奖品ID（无奖时为NULL）。
    - `user_email`：用户邮箱或标识（抽奖时收集）。
    - `draw_time`：抽奖时间。
    - `status`：状态（0=未中奖，1=中奖，2=无效）。
    - `create_time`, `update_time`：时间戳。
- **约束**：外键关联`lottery_codes`和`ld_prizes`。

## 后台逻辑流程

### 1. **管理员操作（后台控制）**
- **奖品管理**：
    - 通过后台界面增删改查`ld_prizes`，设置`stock`控制奖品数量。
    - 示例：添加新奖品时，输入名称、图片、库存等。
- **生成抽奖码**：
    - 管理员触发脚本，按奖品库存生成抽奖码，额外生成无奖码控制中奖率。
    - 示例伪代码（Python风格）：
      ```python
      for prize in prizes:
          for i in range(1, prize.stock + 1):
              code = f"LC-{prize.name.replace(' ', '-')}-{i:03d}"
              insert into lottery_codes (code, prize_id, ...)
      # 生成无奖码
      for i in range(1, no_win_count + 1):
          code = f"LC-NOWIN-{i:03d}"
          insert into lottery_codes (code, prize_id=NULL, ...)
      ```
- **查看报表**：
    - 查询`ld_draw_records`获取抽奖历史、中奖者等。
    - 监控`ld_prizes`的库存和`lottery_codes`的使用情况。

### 2. **用户抽奖流程（前端/后台）**
- **步骤1：用户输入抽奖码**
    - 前端提示“请输入抽奖码”。
- **步骤2：后台验证**
    - 查询`lottery_codes`：`WHERE code = 输入码 AND is_used = 0`。
    - 若未找到：返回“无效抽奖码”（状态2）。
    - 若找到：
        - 获取`prize_id`。
        - 若`prize_id`为NULL：未中奖（状态0）。
        - 若`prize_id`非NULL：
            - 检查`ld_prizes.stock` > 0。
            - 若库存足够：中奖，减少库存，状态1。
            - 若无库存：视为未中奖，状态0。
- **步骤3：更新记录**
    - 更新`lottery_codes`：设置`is_used = 1`，`used_time = NOW()`。
    - 插入`ld_draw_records`：记录`code_id`、`prize_id`（若中奖）、`user_email`（前端输入）、`draw_time`、`status`。
- **步骤4：返回结果**
    - 中奖：显示奖品信息（名称、图片）。
    - 未中奖：显示“谢谢参与”或类似提示。
    - 实体奖品可能需要用户提供邮箱以便配送。

### 3. **其他逻辑**
- **中奖率控制**：通过生成更多无奖码（`prize_id = NULL`）控制中奖概率，例如10%中奖率（1个中奖码对应9个无奖码）。
- **用户标识**：抽奖时收集用户邮箱，记录到`user_email`。
- **事务处理**：使用数据库事务确保库存减少、码使用标记等操作原子性。
- **错误处理**：处理重复码、过期码等异常。
- **预设数据**：SQL包含示例抽奖码，管理员可通过脚本生成更多。

## 实现注意事项
- **安全性**：验证输入，防止抽奖码猜测（使用长且唯一码）。
- **性能**：在`code`和`prize_id`上建立索引以加快查询。
- **前端集成**：提供API（如POST /draw，含抽奖码和邮箱），后台管理界面。
- **工具需求**：后端框架（如PHP/Node.js）处理CRUD，脚本生成抽奖码。

本系统支持后台全面控制奖品和抽奖流程，同时记录所有操作以确保透明性。