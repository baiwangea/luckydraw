{extend name="common/layout" /}

{block name="title"}æŠ½å¥–ç è¯¦æƒ…{/block}

{block name="body"}
<div class="layui-form">
    <div class="layui-form-item">
        <label class="layui-form-label">æŠ½å¥–ç ID</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">{$data.id}</div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">æŠ½å¥–ç </label>
        <div class="layui-input-block">
            <div class="layui-form-mid" style="font-family: monospace; font-size: 16px; font-weight: bold; color: #1E9FFF;">
                {$data.code}
                <button class="layui-btn layui-btn-xs layui-btn-primary" id="copy-code" data-code="{$data.code}" style="margin-left: 10px;">
                    <i class="layui-icon layui-icon-file"></i> å¤åˆ¶
                </button>
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">å…³è”å¥–å“</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">
                {if $data.prize}
                    <span style="color: #5FB878;">{$data.prize.name}</span>
                    {if $data.prize.image}
                        <img src="{$data.prize.image}" alt="" style="width: 40px; height: 40px; margin-left: 10px; vertical-align: middle; border-radius: 4px;">
                    {/if}
                {else}
                    <span style="color: #999;">æœªå…³è”å¥–å“</span>
                {/if}
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">ä½¿ç”¨çŠ¶æ€</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">
                {if $data.status == 'UNUSED'}
                    <span class="layui-badge layui-bg-green">æœªä½¿ç”¨</span>
                {else}
                    <span class="layui-badge layui-bg-gray">å·²ä½¿ç”¨</span>
                {/if}
            </div>
        </div>
    </div>

    {if $data.status == 'USED'}
    <div class="layui-form-item">
        <label class="layui-form-label">ä½¿ç”¨è€…é‚®ç®±</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">
                {if $data.user_email}
                    {$data.user_email}
                {else}
                    <span style="color: #999;">æœªè®°å½•</span>
                {/if}
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">ä½¿ç”¨æ—¶é—´</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">
                {if $data.used_at}
                    {$data.used_at}
                {else}
                    <span style="color: #999;">æœªè®°å½•</span>
                {/if}
            </div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">ä¸­å¥–ç»“æœ</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">
                {if $data.draw_record}
                    {if $data.draw_record.status == 'WON'}
                        <span style="color: #FF5722; font-weight: bold;">ğŸ‰ ä¸­å¥–</span>
                        {if $data.draw_record.prize.name}
                            - {$data.draw_record.prize.name}
                        {/if}
                    {elseif $data.draw_record.status == 'INVALID'}
                        <span style="color: #FF0000; font-weight: bold;">âŒ æ— æ•ˆ</span>
                    {else}
                        <span style="color: #999;">æœªä¸­å¥–</span>
                    {/if}
                {else}
                    <span style="color: #999;">æ— æŠ½å¥–è®°å½•</span>
                {/if}
            </div>
        </div>
    </div>
    {/if}

    <div class="layui-form-item">
        <label class="layui-form-label">åˆ›å»ºæ—¶é—´</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">{$data.created_at}</div>
        </div>
    </div>

    <div class="layui-form-item">
        <label class="layui-form-label">æ›´æ–°æ—¶é—´</label>
        <div class="layui-input-block">
            <div class="layui-form-mid">{$data.updated_at}</div>
        </div>
    </div>

    {if $data.status == 'USED' && $data.draw_record}
    <div class="layui-form-item">
        <div class="layui-form-label">æŠ½å¥–è¯¦æƒ…</div>
        <div class="layui-input-block">
            <div class="layui-card">
                <div class="layui-card-body">
                    <table class="layui-table" lay-size="sm">
                        <tbody>
                            <tr>
                                <td width="100">æŠ½å¥–æ—¶é—´</td>
                                <td>{$data.draw_record.created_at}</td>
                            </tr>
                            <tr>
                                <td>æŠ½å¥–ç»“æœ</td>
                                <td>
                                    {if $data.draw_record.status == 'WON'}
                                        <span style="color: #FF5722; font-weight: bold;">ä¸­å¥–</span>
                                    {elseif $data.draw_record.status == 'INVALID'}
                                        <span style="color: #FF0000; font-weight: bold;">æ— æ•ˆ</span>
                                    {else}
                                        <span style="color: #999;">æœªä¸­å¥–</span>
                                    {/if}
                                </td>
                            </tr>
                            {if $data.draw_record.status == 'WON'}
                            <tr>
                                <td>ä¸­å¥–å¥–å“</td>
                                <td>{$data.draw_record.prize.name|default='æœªçŸ¥å¥–å“'}</td>
                            </tr>
                            <tr>
                                <td>å¥–å“ä»·å€¼</td>
                                <td>Â¥{$data.draw_record.prize.price|default=0}</td>
                            </tr>
                            {/if}
                            <tr>
                                <td>IPåœ°å€</td>
                                <td>{$data.draw_record.ip|default='æœªè®°å½•'}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {/if}

    <div class="layui-form-item text-center">
        <button type="button" class="layui-btn layui-btn-primary" onclick="parent.layer.closeAll();">å…³é—­</button>
        {if $data.status == 'UNUSED'}
        <button type="button" class="layui-btn layui-btn-danger" id="delete-code">åˆ é™¤æŠ½å¥–ç </button>
        {/if}
    </div>
</div>
{/block}

{block name="script"}
<script>
    layui.use(['layer'], function () {
        const layer = layui.layer;

        // å¤åˆ¶æŠ½å¥–ç 
        $('#copy-code').click(function() {
            const code = $(this).data('code');
            
            // åˆ›å»ºä¸´æ—¶è¾“å…¥æ¡†
            const tempInput = document.createElement('input');
            tempInput.value = code;
            document.body.appendChild(tempInput);
            tempInput.select();
            
            try {
                document.execCommand('copy');
                layer.msg('æŠ½å¥–ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', {icon: 1});
            } catch (err) {
                layer.msg('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', {icon: 2});
            }
            
            document.body.removeChild(tempInput);
        });

        // åˆ é™¤æŠ½å¥–ç 
        $('#delete-code').click(function() {
            layer.confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæŠ½å¥–ç å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ï¼', {icon: 3, title: 'ç¡®è®¤åˆ é™¤'}, function (index) {
                $.post('{:route("lottery.lottery_code/del")}', {id: '{$data.id}'}, function (res) {
                    if (res.code === 200) {
                        layer.msg(res.msg, {icon: 1}, function () {
                            parent.layer.closeAll();
                        });
                    } else {
                        layer.msg(res.msg, {icon: 2});
                    }
                });
                layer.close(index);
            });
        });
    });
</script>
{/block}